function appViewModel(){function e(e){var t="http://api.greatschools.org/schools/nearby?key=kge2fgxsc82fv6mvydwjrqxx&state=CA&zip=95014",s="http://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent('select * from xml where url="'+t+'"')+"&format=xml&callback=?";$("#loading").html("<article><h2>Loading...</h2></article>"),m.isGettingInfoFromApi(!0),$.getJSON(s,function(e,t,s){var i,a,n,l,c,h,u,p=e.results[0];-1===p.indexOf("error")&&(clearTimeout(m.greatSchoolsTimeout),$("#loading").html("<article><h2>Got the School info from GreatSchools.org</h2></article>"),m.isGettingInfoFromApi(!0));var d=0;$(p).find("school").each(function(){$(this).find("address").text().indexOf(m.zipcode())>-1&&(d++,$("#loading").html("<article><h2>Found "+d+"schools in 95014</h2></article>"),m.isGettingInfoFromApi(!0),i=$(this).find("gsId").text(),a=$(this).find("name").text(),u=$(this).find("type").text(),l=$(this).find("lat").text(),c=$(this).find("lon").text(),h=$(this).find("gradeRange").text(),n=o(u,h,a),r(i),m.schools.push(new School(i,a,n,l,c,"","")))})})}function o(e,o,r){if("private"===e)return"Private";if("public"===e)switch(o){case"9-12":case"7-12":return"High";case"K-5":case"K-6":case"PK-5":return"Elementary";case"6-8":case"7-8":return"Middle";case"K-8":return"K-8";default:return"High"}}function r(e){$("#loading").html("<article><h2>Loading Scores...</h2></article>"),m.isGettingInfoFromApi(!0);var o,r="http://api.greatschools.org/school/tests/CA/"+e+"?key=kge2fgxsc82fv6mvydwjrqxx",s="http://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent('select * from xml where url="'+r+'"')+"&format=xml&callback=?";$.getJSON(s,function(r,s,i){var a=r.results[0];if(-1===a.indexOf("error")&&clearTimeout(m.greatSchoolsScoresTimeout),""===$(a).find("score").first().text()?o="No Scores Available (Private school)":(clearTimeout(m.greatSchoolsTimeout),o=$(a).find("score").first().text()),m.schoolScores.push(new SchoolScores(e,o)),m.schools().length!==m.schoolScores().length||m.isMakingMarkers()){var n=Math.floor(m.schoolScores().length/m.schools().length*100);$("#loading").html("<article><h2>Loading Scores - "+n+"% complete</h2></article>"),m.isGettingInfoFromApi(!0),m.isMakingMarkers(!1)}else l(m.schoolScores(),m.schools()),t(m.zipcode,m.schools())})}function t(e,o){for(var r=0;r<o.length;r++)s("95014",o[r].schoolName,o[r].schoolGsId,"cb"+r)}function s(e,o,r,t){var s={consumerKey:"NrQS4PQoWHfdK6uJSjj6HA",consumerSecret:"5YiLiGo3wmF6oBRUe3fJSBaTQfw",accessToken:"FS9x9XyEBQDxH4rcT9eXm26yRQoqOB9f",accessTokenSecret:"xO1PqPj_3BIL_oG87nkq6tZe-hw",serviceProvider:{signatureMethod:"HMAC-SHA1"}},a={consumerSecret:s.consumerSecret,tokenSecret:s.accessTokenSecret},n=[];n.push(["term",o]),n.push(["location",e]),n.push(["callback",t]),n.push(["oauth_consumer_key",s.consumerKey]),n.push(["oauth_consumer_secret",s.consumerSecret]),n.push(["oauth_token",s.accessToken]),n.push(["oauth_signature_method","HMAC-SHA1"]);var l={action:"http://api.yelp.com/v2/search",method:"GET",parameters:n};OAuth.setTimestampAndNonce(l),OAuth.SignatureMethod.sign(l,a);var c=OAuth.getParameterMap(l.parameters);i(l.action,c,o,r,t)}function i(e,o,r,t,s){$.ajax({url:e,data:o,dataType:"jsonp",global:!0,jsonpCallback:s,success:function(e){clearTimeout(m.yelpTimeout);var o=a(e,r),s=n(e,r);if(m.schoolReviews.push(new Reviews(t,o,s)),m.schools().length!==m.schoolScores().length||m.schools().length!==m.schoolReviews().length||m.isMakingMarkers()){var i=Math.floor(m.schoolReviews().length/m.schools().length*100);$("#loading").html("<article><h2>Loading Yelp Reviews - "+i+"% complete</h2></article>"),m.isGettingInfoFromApi(!0),m.isMakingMarkers(!1)}else m.isGettingInfoFromApi(!1),l(m.schoolScores(),m.schools()),l(m.schoolReviews(),m.schools()),d(m.schools())}})}function a(e,o){var r=e.businesses;if(r.length>0){for(var t=0;t<r.length;t++){var s=r[t];if(o===s.name||o.indexOf(s.name)>-1||s.name.indexOf(o)>-1)return s.rating+" stars based on "+s.review_count+" reviews"}return"No reviews found"}return"No reviews found"}function n(e,o){var r=e.businesses;if(r.length>0){for(var t=0;t<r.length;t++){var s=r[t];if(o===s.name||o.indexOf(s.name)>-1||s.name.indexOf(o)>-1)return s.url}return"http://www.yelp.com"}return"http://www.yelp.com"}function l(e,o){for(var r=e.length,t=o.length,s=0;t>s;s++)for(var i=s;r>i;i++)if(o[s].schoolGsId===e[i].schoolGsId&&s!=i){var a=e[i];e.splice(i,1),e.splice(s,0,a);break}return e}function c(e){$.each(m.schools(),function(e){m.mapMarkers()[e].marker.setVisible(!1)});var o=m.mapMarkers()[e].marker;o.setVisible(!0),google.maps.event.trigger(o,"click")}function h(){g=new google.maps.Map(document.getElementById("googlemap-canvas"),{zoom:13,center:{lat:m.latitude(),lng:m.longitude()}}),clearTimeout(m.mapTimeout),e(m.zipcode)}function u(e){return m.schoolScores()[e]}function p(e){return m.schoolReviews()[e]}function d(e){m.isMakingMarkers(!0),$.each(e,function(e){var o,r=m.schools(),t=r[e],s=e,i=u(s),a=p(s),n=new google.maps.LatLng(t.schoolLatitude,t.schoolLongitude);o=void 0!==typeof a.reviewUrl||"No reviews found"!=a.reviewUrl||"http://www.yelp.com"!=a.reviewUrl?'<div id="infowindow"><h2>'+t.schoolName+'</h2><p class="score">GreatSchool Score: '+i.schoolScore+'</p><p class="ratingLink">Yelp Rating: '+a.rating+'</p><p><a class="ratingLink" href="'+a.reviewUrl+'">Yelp Review</a></p></div>':'<div id="infowindow"><h2>'+t.schoolName+'</h2><p class="score">GreatSchool Score: '+i.schoolScore+'</p><p class="rating">Yelp Rating: '+a.rating+"</p></div>";var l,c=new google.maps.Marker({position:n,map:g,title:t.schoolName,visible:!0});switch(t.schoolType){case"Elementary":l="images/blue-dot.png";break;case"Middle":l="images/yellow-dot.png";break;case"High":l="images/green-dot.png";break;case"Private":l="images/purple-dot.png";break;case"K-8":l="images/red-dot.png"}var h=new google.maps.Marker({position:n,map:g,title:t.schoolName,icon:l,visible:!1});c.setLabel(m.schoolTypeInitial()[e]);var d=new google.maps.InfoWindow({content:o});google.maps.event.addListener(d,"closeclick",function(){m.isInfoWindowVisible(!1),m.shouldShowSearchSection(!0),m.currentMarker().setAnimation(null),m.currentMarker().setLabel(m.currentMarkerInitial()),m.clearFilter()}),c.setMap(g),h.setMap(g),m.mapMarkers.push({marker:c,content:o,infowindow:d}),m.classifiedMapMarkers.push({marker:h,type:t.schoolType}),google.maps.event.addListener(c,"click",function(){m.currentMarker(c),m.currentMarkerInitial(m.currentMarker().getLabel()),m.currentMarker().setLabel(""),m.currentMarker().setAnimation(google.maps.Animation.BOUNCE),d.open(g,c),m.isInfoWindowVisible(!0),m.shouldShowSearchSection(!1)}),h.setClickable(!1)})}var g,m=this;m.defaultZipCode="95014",m.zipcode=ko.observable(m.defaultZipCode),m.latitude=ko.observable(37.318602),m.longitude=ko.observable(-122.046305),m.searchType=ko.observable(""),m.schools=ko.observableArray([]),m.schoolScores=ko.observableArray([]),m.schoolReviews=ko.observableArray([]),m.mapMarkers=ko.observableArray([]),m.classifiedMapMarkers=ko.observableArray([]),m.isInfoWindowVisible=ko.observable(!1),m.shouldShowSearchSection=ko.observable(!0),m.isColorMarkerShown=ko.observable(!1),m.isGettingInfoFromApi=ko.observable(!0),m.isMakingMarkers=ko.observable(!1),m.currentMarker=ko.observable(),m.currentMarkerInitial=ko.observable(),m.toggleButtonName=ko.observable("Show Colored Markers"),m.currentSchoolIndex=ko.observable(),m.schoolTypeInitial=ko.computed(function(){return ko.utils.arrayMap(m.schools(),function(e){return e.schoolType.slice(0,1)})}),m.mapTimeout=setTimeout(function(){alert("Oops. We aren't too proud of this!!!! But we did hit an issue with Google maps. Please try again later :(")},8e3),m.greatSchoolsTimeout=setTimeout(function(){alert("Oops. We aren't too proud of this!!!! But we did hit an issue with Great Schools. Please try again later :(")},8e3),m.greatSchoolsScoresTimeout=setTimeout(function(){alert("Oops. We aren't too proud of this!!!! But we did hit an issue with Great Schools. Please try again later :(")},8e3),m.yelpTimeout=setTimeout(function(){alert("Oops. We aren't too proud of this!!!! But we did hit an issue with Yelp. Please try again later :(")},8e3),this.clearFilter=function(){m.searchType(""),$.each(m.schools(),function(e){m.mapMarkers()[e].marker.setVisible(!0)})},this.filterSchoolsByType=function(){$.each(m.schools(),function(e){m.mapMarkers()[e].marker.setVisible(m.searchType().length>0?m.schools()[e].schoolType.toLowerCase()===m.searchType().toLowerCase()?!0:!1:!0)})},this.setCurrentSchoolIndex=function(e){m.currentSchoolIndex(e()),c(m.currentSchoolIndex())},this.toggleColorCodedMarkers=function(){"Show Colored Markers"===m.toggleButtonName()?(m.isColorMarkerShown(!0),m.toggleButtonName("Show Clickable Markers"),$.each(m.mapMarkers(),function(e){m.mapMarkers()[e].marker.setVisible(!1),m.classifiedMapMarkers()[e].marker.setVisible(!0)})):(m.isColorMarkerShown(!1),m.toggleButtonName("Show Colored Markers"),$.each(m.mapMarkers(),function(e){m.mapMarkers()[e].marker.setVisible(!0),m.classifiedMapMarkers()[e].marker.setVisible(!1)}))},window.addEventListener("resize",function(e){var o=g.getCenter();google.maps.event.trigger(g,"resize"),g.setCenter(o)}),google.maps.event.addDomListener(window,"load",h),m.searchOptions=["Elementary","Middle","High","Private","K-8"]}var School=function(e,o,r,t,s,i,a){this.schoolName=o,this.schoolType=r,this.schoolLatitude=t,this.schoolLongitude=s,this.schoolGsId=e,this.schoolScore=ko.observable(i),this.schoolReview=a},SchoolScores=function(e,o){this.schoolGsId=e,this.schoolScore=o},Reviews=function(e,o,r){this.schoolGsId=e,this.rating=o,this.reviewUrl=r};ko.applyBindings(new appViewModel),ko.bindingHandlers.executeOnEnter={init:function(e,o,r,t){var s=o();$(e).keypress(function(e){var o=e.which?e.which:e.keyCode;return 13===o?(s.call(t),!1):!0})}};